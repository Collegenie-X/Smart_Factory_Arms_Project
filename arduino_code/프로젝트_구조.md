# 스마트 팩토리 아두이노 C 프로젝트 구조

## 📦 전체 파일 구조

```
arduino_code/
│
├── 📘 README.md                         # 프로젝트 사용 설명서
├── 📘 알고리즘_설명서.md                # 핵심 알고리즘 상세 문서
├── 📘 프로젝트_구조.md                  # 본 파일
│
├── 📁 common/                           # 공통 모듈
│   ├── config.h                         # 전역 설정 파일
│   │   ├── 핀 번호 정의 (서보, 센서, 모터)
│   │   ├── 상수 정의 (각도, 속도, 타이밍)
│   │   ├── 임계값 정의 (센서, AI)
│   │   └── 디버그 매크로
│   │
│   ├── types.h                          # 자료구조 정의
│   │   ├── 열거형 (SystemState, Color, Zone 등)
│   │   ├── 구조체 (RobotPosition, Statistics 등)
│   │   ├── LED 아이콘 패턴
│   │   └── 유틸리티 함수
│   │
│   ├── exception_handler.h              # 예외 처리 헤더
│   └── exception_handler.cpp            # 예외 처리 구현
│       ├── 지수 백오프 알고리즘
│       ├── 5가지 예외 유형 처리
│       └── 재시도 로직
│
├── 📁 day1_robot_arm/                   # Day 1: 로봇팔 기본 제어
│   ├── day1_robot_arm.ino               # 메인 프로그램
│   │   ├── setup(): 시스템 초기화
│   │   ├── loop(): 명령 수신 및 실행
│   │   └── executeCommand(): 명령 처리
│   │
│   ├── servo_sync_movement.h            # 서보 동기화 헤더
│   └── servo_sync_movement.cpp          # 서보 동기화 구현
│       ├── synchronizedMove()           # 선형 보간 이동
│       ├── pickSequence()               # 집기 시퀀스
│       ├── placeSequence()              # 놓기 시퀀스
│       └── validatePosition()           # 각도 검증
│   │
│   ├── bluetooth_protocol.h             # 블루투스 헤더
│   └── bluetooth_protocol.cpp           # 블루투스 구현
│       ├── parseCommand()               # 명령 파싱
│       ├── sendResponse()               # 응답 전송
│       └── sendStatus()                 # 상태 JSON 전송
│   │
│   ├── eeprom_storage.h                 # EEPROM 헤더
│   └── eeprom_storage.cpp               # EEPROM 구현
│       ├── savePosition()               # 위치 저장
│       ├── loadPosition()               # 위치 복구
│       └── calculateChecksum()          # 체크섬 계산
│
├── 📁 day2_conveyor_sensor/             # Day 2: 센서 + 컨베이어
│   ├── day2_conveyor_system.ino         # 메인 프로그램
│   │   ├── 컨베이어 자동 작동
│   │   ├── IR 센서 폴링
│   │   ├── 색상 분류 로직
│   │   └── 통계 수집
│   │
│   ├── color_sensor.h                   # 컬러 센서 헤더
│   └── color_sensor.cpp                 # 컬러 센서 구현
│       ├── readRGB()                    # RGB 값 읽기
│       ├── detectColor()                # 유클리드 거리 판단
│       ├── readColorFiltered()          # 중앙값 필터
│       └── calibrate()                  # 캘리브레이션
│   │
│   ├── motor_controller.h               # 모터 제어 헤더
│   └── motor_controller.cpp             # 모터 제어 구현
│       ├── setSpeed()                   # PWM 속도 제어
│       ├── setDirection()               # H-Bridge 방향 제어
│       └── smoothAccel()                # 부드러운 가속
│
└── 📁 day3_scenarios/                   # Day 3: 통합 시나리오
    ├── scenario_a_ai_smart.ino          # 시나리오 A 메인
    │   ├── AI + 센서 하이브리드 검증
    │   ├── 로봇팔 + 컨베이어 통합
    │   └── 블루투스 명령 처리
    │
    ├── state_machine.h                  # 상태 머신 헤더
    └── state_machine.cpp                # 상태 머신 구현
        ├── update()                     # 상태 머신 업데이트
        ├── transitionTo()               # 상태 전이
        ├── receiveAICommand()           # AI 명령 수신
        └── emergencyStop()              # 비상 정지
```

---

## 🔗 모듈 간 의존성 관계

```
┌─────────────────────────────────────────────────┐
│                   common/                       │
│  ┌──────────┐  ┌────────┐  ┌─────────────────┐ │
│  │ config.h │  │types.h │  │exception_handler│ │
│  └────┬─────┘  └───┬────┘  └────────┬────────┘ │
└───────┼────────────┼────────────────┼──────────┘
        │            │                │
        ↓            ↓                ↓
┌───────────────────────────────────────────┐
│              day1_robot_arm/              │
│  ┌──────────────────┐  ┌────────────────┐│
│  │servo_sync_movement│  │bluetooth_proto.││
│  └──────────────────┘  └────────────────┘│
│  ┌──────────────────┐                    │
│  │eeprom_storage    │                    │
│  └──────────────────┘                    │
└───────────────────────────────────────────┘
        │                    │
        ↓                    ↓
┌───────────────────────────────────────────┐
│           day2_conveyor_sensor/           │
│  ┌─────────────┐  ┌────────────────────┐ │
│  │color_sensor │  │motor_controller    │ │
│  └─────────────┘  └────────────────────┘ │
└───────────────────────────────────────────┘
        │                    │
        ↓                    ↓
┌───────────────────────────────────────────┐
│            day3_scenarios/                │
│  ┌─────────────────┐                     │
│  │state_machine    │  (모든 모듈 통합)   │
│  └─────────────────┘                     │
│  ┌─────────────────────────────────────┐ │
│  │scenario_a_ai_smart.ino              │ │
│  └─────────────────────────────────────┘ │
└───────────────────────────────────────────┘
```

---

## 📚 파일별 핵심 알고리즘

### ⚙️ common/config.h
- **목적**: 시스템 전역 설정
- **내용**: 핀 번호, 상수, 임계값
- **라인 수**: ~200줄

### 🏗️ common/types.h
- **목적**: 자료구조 정의
- **내용**: 열거형, 구조체, 유틸리티
- **라인 수**: ~300줄

### 🔧 common/exception_handler.cpp
- **알고리즘**: 지수 백오프
- **시간 복잡도**: O(r), r = 재시도 횟수
- **라인 수**: ~150줄

### 🤖 day1_robot_arm/servo_sync_movement.cpp
- **알고리즘**: 선형 보간 동기화 이동
- **시간 복잡도**: O(n), n = 스텝 수
- **핵심 함수**:
  - `synchronizedMove()`: 217줄
  - `pickSequence()`: 60줄
  - `placeSequence()`: 50줄
- **라인 수**: ~350줄

### 📡 day1_robot_arm/bluetooth_protocol.cpp
- **알고리즘**: 명령 프로토콜 파싱
- **시간 복잡도**: O(m), m = 파라미터 개수
- **핵심 함수**:
  - `parseCommand()`: 150줄
  - `sendStatus()`: 30줄
- **라인 수**: ~300줄

### 💾 day1_robot_arm/eeprom_storage.cpp
- **알고리즘**: 체크섬 검증 저장/복구
- **시간 복잡도**: O(1)
- **핵심 함수**:
  - `savePosition()`: 40줄
  - `loadPosition()`: 60줄
- **라인 수**: ~150줄

### 🎨 day2_conveyor_sensor/color_sensor.cpp
- **알고리즘**: 유클리드 거리 색상 판단
- **시간 복잡도**: O(k), k = 기준 색상 수
- **핵심 함수**:
  - `detectColor()`: 40줄
  - `readColorFiltered()`: 50줄
  - `calibrate()`: 30줄
- **라인 수**: ~250줄

### ⚡ day2_conveyor_sensor/motor_controller.cpp
- **알고리즘**: PWM 속도 제어
- **시간 복잡도**: O(1)
- **핵심 함수**:
  - `setSpeed()`: 20줄
  - `smoothAccel()`: 40줄
- **라인 수**: ~150줄

### 🔄 day3_scenarios/state_machine.cpp
- **알고리즘**: 상태 머신 (10가지 상태)
- **시간 복잡도**: O(1)
- **핵심 함수**:
  - `update()`: 150줄
  - `transitionTo()`: 10줄
- **라인 수**: ~300줄

---

## 📊 코드 통계

### 전체 프로젝트
| 구분 | 파일 수 | 총 라인 수 | 비율 |
|------|---------|------------|------|
| 헤더 파일 (.h) | 8 | ~800줄 | 30% |
| 구현 파일 (.cpp) | 7 | ~1500줄 | 55% |
| 메인 파일 (.ino) | 3 | ~400줄 | 15% |
| **합계** | **18** | **~2700줄** | **100%** |

### 모듈별 분포
```
common/               20%  ████
day1_robot_arm/       35%  ███████
day2_conveyor_sensor/ 25%  █████
day3_scenarios/       20%  ████
```

### 알고리즘별 복잡도
| 알고리즘 | 복잡도 | 중요도 |
|----------|--------|--------|
| 동기화 이동 | O(n) | ⭐⭐⭐⭐⭐ |
| 색상 판단 | O(k) | ⭐⭐⭐⭐ |
| 상태 머신 | O(1) | ⭐⭐⭐⭐⭐ |
| 예외 처리 | O(r) | ⭐⭐⭐⭐ |
| EEPROM | O(1) | ⭐⭐⭐ |

---

## 🔄 데이터 흐름

### Day 1: 로봇팔 제어
```
블루투스 명령 입력
    ↓
bluetooth_protocol.parseCommand()
    ↓
day1_robot_arm.executeCommand()
    ↓
servo_sync_movement.synchronizedMove()
    ↓
하드웨어 서보 제어
```

### Day 2: 센서 분류
```
컨베이어 작동
    ↓
IR 센서 감지
    ↓
motor_controller.stop()
    ↓
color_sensor.readColorFiltered()
    ↓
분류 게이트 제어
```

### Day 3: AI 통합
```
앱에서 AI 스캔 (Teachable Machine)
    ↓
블루투스 명령 전송 (A RED 1)
    ↓
state_machine.receiveAICommand()
    ↓
STATE_PICKING → servo_sync_movement
    ↓
STATE_TRANSPORTING → motor_controller
    ↓
STATE_VERIFYING → color_sensor
    ↓
STATE_SORTING (성공/실패)
```

---

## 🛠️ 빌드 및 업로드 가이드

### 1. Arduino IDE 설정
```
1. Arduino IDE 1.8.19 이상 설치
2. 보드: Arduino UNO/MEGA 선택
3. 포트: 자동 감지된 COM 포트 선택
```

### 2. 라이브러리 확인
```
필수 라이브러리 (모두 기본 내장):
- Servo.h
- EEPROM.h
- Arduino.h
```

### 3. 컴파일 순서
```
Day 1:
  arduino_code/day1_robot_arm/day1_robot_arm.ino 열기
  → 검증 (Ctrl+R)
  → 업로드 (Ctrl+U)

Day 2:
  arduino_code/day2_conveyor_sensor/day2_conveyor_system.ino 열기
  → 검증
  → 업로드

Day 3:
  arduino_code/day3_scenarios/scenario_a_ai_smart.ino 열기
  → 검증
  → 업로드
```

### 4. 시리얼 모니터 설정
```
- Baud Rate: 9600
- Line Ending: Newline
- 타임스탬프: 선택 사항
```

---

## 🎓 학습 경로 추천

### 초급 (Day 1)
1. `common/types.h` 읽기 (자료구조 이해)
2. `servo_sync_movement.cpp` 분석 (동기화 알고리즘)
3. `bluetooth_protocol.cpp` 분석 (파싱 알고리즘)
4. `day1_robot_arm.ino` 실행 및 테스트

### 중급 (Day 2)
1. `color_sensor.cpp` 분석 (유클리드 거리)
2. `motor_controller.cpp` 분석 (PWM 제어)
3. `day2_conveyor_system.ino` 실행 및 테스트
4. 캘리브레이션 실습

### 고급 (Day 3)
1. `state_machine.cpp` 분석 (상태 머신)
2. `exception_handler.cpp` 분석 (예외 처리)
3. `scenario_a_ai_smart.ino` 실행 및 테스트
4. AI 모델 연동

---

## 📝 커스터마이징 가이드

### 핀 번호 변경
```cpp
// common/config.h 수정
#define PIN_SERVO_BASE      6   → 원하는 핀 번호
```

### 속도 조절
```cpp
// common/config.h 수정
#define SYNC_STEP_DELAY     15  → 10 (빠르게)
#define MOTOR_SPEED_MEDIUM  150 → 200 (빠르게)
```

### 색상 추가
```cpp
// common/types.h에 열거형 추가
enum Color {
  COLOR_RED,
  COLOR_BLUE,
  COLOR_YELLOW,
  COLOR_GREEN  // 추가
};

// color_sensor.cpp에 기준값 추가
refColors.green = {r, g, b};
```

### 구역 추가
```cpp
// common/config.h에 구역 4 추가
#define ZONE4_BASE      160
#define ZONE4_SHOULDER  100
#define ZONE4_ELBOW     90
```

---

## 🐛 디버깅 팁

### 1. 컴파일 오류
```
오류: 'xxx' was not declared in this scope
→ 헤더 파일 include 확인
→ common/ 폴더 경로 확인
```

### 2. 런타임 오류
```
서보 떨림
→ 외부 전원 사용
→ config.h에서 STEP_DELAY 증가

센서 오인식
→ 캘리브레이션 실행
→ 조명 일정하게 유지
```

### 3. 통신 오류
```
블루투스 연결 끊김
→ 거리 2m 이내 유지
→ 배터리 전압 확인
```

---

**프로젝트 정보**
- 제작: Smart Factory Education Team
- 버전: 1.0
- 날짜: 2026-01-22
- 라이선스: 교육용
