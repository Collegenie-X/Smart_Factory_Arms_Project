# 08. Serial + Bluetooth 제어 시스템

## 개요
Serial 통신과 Bluetooth 통신을 동시에 지원하는 스마트 팩토리 컨베이어 시스템입니다.
디버깅을 위해 두 통신 방식 중 하나만 연결해도 동작합니다.

## 주요 기능

### 1. 이중 통신 지원
- **Serial 통신**: USB 케이블을 통한 직접 제어
- **Bluetooth 통신**: 무선 제어 (TX=2, RX=2)
- 둘 중 하나만 연결해도 동작 가능

### 2. 명령어

#### `start_`
- 자동화 시작
- 컨베이어 벨트 가동
- 제품 감지 및 분류 시작

#### `stop_`
- 자동화 중지
- 컨베이어 벨트 정지
- LED 끄기
- 제품 처리 중에도 즉시 반응

#### `init_`
- 카운터 초기화
- 빨간색, 초록색, 파란색 카운터를 0으로 설정
- 전체 제품 카운터도 0으로 초기화
- **자동으로 시스템 중지** (안전한 초기화를 위해)
- 초기화 후 `start_` 명령으로 다시 시작 가능

### 3. 색상별 카운터
제품 색상별로 개수를 카운트하고 전송합니다:
- **빨간색 제품**: `red1_`, `red2_`, `red3_`, ...
- **초록색 제품**: `green1_`, `green2_`, `green3_`, ...
- **파란색 제품**: `blue1_`, `blue2_`, `blue3_`, ...

### 4. 실시간 모니터링
모든 상태 정보가 Serial과 Bluetooth로 동시에 전송됩니다:
- 제품 감지 알림
- 색상 분석 결과 (Raw 값, RGB 값)
- 판별된 색상
- 카운터 정보

## 하드웨어 연결

### 핀 맵
```
DC 모터:
- DIR: 13번 핀
- SPEED (PWM): 11번 핀

서보 모터: 9번 핀
RGB LED: 5번 핀
적외선 센서: A0번 핀
부저: 4번 핀

Bluetooth:
- TX: 2번 핀
- RX: 2번 핀
```

### Bluetooth 모듈 (HC-05/HC-06)
```
VCC → 5V
GND → GND
TXD → 2번 핀 (Arduino RX)
RXD → 2번 핀 (Arduino TX)
```

## 사용 방법

### 1. Serial Monitor 사용
1. Arduino IDE에서 Serial Monitor 열기 (Ctrl+Shift+M)
2. 보레이트: 9600
3. 명령어 입력:
   ```
   start_    // 시작
   stop_     // 중지
   init_     // 초기화
   ```

### 2. Bluetooth 사용
1. Bluetooth 페어링 (비밀번호: 보통 1234 또는 0000)
2. Bluetooth 터미널 앱 사용 (예: Serial Bluetooth Terminal)
3. 명령어 입력:
   ```
   start_
   stop_
   init_
   ```

### 3. 디버깅 모드
- Serial만 연결: USB 케이블만 연결하고 테스트
- Bluetooth만 연결: 무선으로만 테스트
- 둘 다 연결: 동시에 모니터링 가능

## 동작 흐름

```
1. 시스템 초기화
   ↓
2. 명령 대기 (Serial || Bluetooth)
   ↓
3. start_ 수신
   ↓
4. 컨베이어 가동
   ↓
5. 제품 감지 (IR 센서)
   ↓
6. 색상 분석 (Color 센서)
   ↓
7. 색상 판별 (빨강/초록/파랑)
   ↓
8. 서보 모터로 분류
   ↓
9. RGB LED로 색상 표시
   ↓
10. 카운터 증가 및 전송
    ↓
11. 다음 제품 대기
    ↓
    (stop_ 수신 시 → 2번으로)
```

## 출력 예시

### 시작 시
```
========================================
  Serial + Bluetooth 제어 시스템
========================================
초기화 완료

명령어:
  start_ : 자동화 시작
  stop_  : 자동화 중지
  init_  : 카운터 초기화
========================================
명령 대기중...
```

### 제품 처리
```
========================================
제품 #1 감지됨!
========================================
--- 색상 분석 결과 ---
Raw -> R: 330, G: 121, B: 116
RGB -> R: 15, G: 5, B: 5
판별 색상: 빨간색
---------------------
[카운터 전송] red1_
제품 처리 완료
```

### 카운터 초기화
```
[명령 수신 from Serial] init
[알림] 자동화 모드를 먼저 중지합니다.
========================================
  카운터 초기화
========================================
빨간색: 0
초록색: 0
파란색: 0
전체 제품: 0
========================================
명령 대기중...
```

## 주의사항

1. **`_` 문자 필수**: 모든 명령어는 `_`로 끝나야 합니다
2. **Bluetooth 핀 번호**: TX와 RX 모두 2번 핀 사용 (SoftwareSerial)
3. **동시 명령**: Serial과 Bluetooth에서 동시에 명령을 보내도 안전하게 처리됩니다
4. **실시간 중지**: 제품 처리 중에도 `stop_` 명령이 50ms 이내에 반응합니다
5. **init 명령**: `init_` 실행 시 자동으로 시스템이 중지되므로, 재시작하려면 `start_`를 다시 입력하세요

## 트러블슈팅

### Bluetooth 연결 안됨
- Bluetooth 모듈 전원 확인
- 페어링 상태 확인
- 보레이트 9600 확인

### 명령 인식 안됨
- `_` 문자 포함 확인
- Serial/Bluetooth 보레이트 9600 확인
- 개행 문자 설정 무관 (자동 필터링)

### 카운터 정보 수신 안됨
- Serial Monitor와 Bluetooth 터미널 모두 확인
- 제품이 정상적으로 분류되는지 확인
