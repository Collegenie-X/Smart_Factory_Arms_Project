# 앱인벤터 센서 통신 프로토콜 - 아두이노 구현

## 📌 개요

이 프로젝트는 **앱인벤터**와 **아두이노** 간 센서 데이터를 주고받는 **양방향 블루투스 통신**을 구현합니다.

### 주요 기능
- ✅ 색상 센서 데이터 전송 (RGB 값)
- ✅ LED, 모터, 서보 제어
- ✅ 프로토콜 기반 통신
- ✅ 에러 처리 및 ACK 응답
- ✅ Serial Monitor 디버깅

---

## 🚀 빠른 시작

### 1단계: 하드웨어 연결

#### 필수 연결

```
아두이노 우노
├─ HC-05 블루투스
│  ├─ VCC  → 5V
│  ├─ GND  → GND
│  ├─ TXD  → D10
│  └─ RXD  → D11
│
├─ RGB LED (공통 캐소드)
│  ├─ R    → D9
│  ├─ G    → D6
│  ├─ B    → D5
│  └─ GND  → GND
│
├─ DC 모터
│  └─ IN1  → D3
│
└─ 서보 모터
   ├─ 신호 → D4
   └─ 전원 → 5V
```

#### 색상 센서 (선택)

**방법 1: 시뮬레이션 (기본)**
```
가변저항 3개 연결
├─ R → A0
├─ G → A1
└─ B → A2
```

**방법 2: 실제 TCS34725 센서**
```
TCS34725
├─ VIN → 5V
├─ GND → GND
├─ SCL → A5
└─ SDA → A4

코드 수정:
#define USE_REAL_SENSOR 1
```

### 2단계: 라이브러리 설치

#### 실제 센서 사용 시

```
Arduino IDE → 스케치 → 라이브러리 포함하기 → 라이브러리 관리

1. "Adafruit TCS34725" 검색 → 설치
2. "Adafruit BusIO" 검색 → 설치
```

### 3단계: 코드 업로드

```
1. Arduino IDE 열기
2. 10_app_inventor_sensor_protocol.ino 열기
3. 보드: Arduino Uno 선택
4. 포트 선택
5. 업로드 (Ctrl+U)
```

### 4단계: 테스트

```
1. Serial Monitor 열기 (9600 baud)
2. "[시스템] 준비 완료" 확인
3. "REQ:COLOR_" 입력
4. "SENSOR:255,128,64_" 출력 확인
```

---

## 📡 프로토콜 규약

### 앱인벤터 → 아두이노 (요청/제어)

| 명령 | 설명 | 예시 |
|------|------|------|
| `REQ:COLOR_` | 색상 센서값 요청 | `REQ:COLOR_` |
| `REQ:STATUS_` | 시스템 상태 요청 | `REQ:STATUS_` |
| `REQ:ALL_` | 모든 데이터 요청 | `REQ:ALL_` |
| `CMD:LED,R,G,B_` | LED 제어 | `CMD:LED,255,0,0_` |
| `CMD:MOTOR_ON_` | 모터 켜기 | `CMD:MOTOR_ON_` |
| `CMD:MOTOR_OFF_` | 모터 끄기 | `CMD:MOTOR_OFF_` |
| `CMD:SERVO,각도_` | 서보 제어 | `CMD:SERVO,90_` |
| `CMD:RESET_` | 시스템 리셋 | `CMD:RESET_` |

### 아두이노 → 앱인벤터 (응답/데이터)

| 응답 | 설명 | 예시 |
|------|------|------|
| `SENSOR:R,G,B_` | 센서 데이터 | `SENSOR:255,128,64_` |
| `STATUS:모터,서보_` | 시스템 상태 | `STATUS:1,90_` |
| `ACK:OK_` | 명령 수신 확인 | `ACK:OK_` |
| `ERROR:코드_` | 에러 코드 | `ERROR:100_` |
| `READY_` | 시스템 준비 | `READY_` |

---

## 🧪 테스트 명령어

### Serial Monitor 테스트

```
1. 색상 센서 읽기
   입력: REQ:COLOR_
   출력: SENSOR:255,128,64_

2. LED 빨강
   입력: CMD:LED,255,0,0_
   출력: ACK:OK_

3. LED 초록
   입력: CMD:LED,0,255,0_
   출력: ACK:OK_

4. LED 파랑
   입력: CMD:LED,0,0,255_
   출력: ACK:OK_

5. LED 노랑
   입력: CMD:LED,255,255,0_
   출력: ACK:OK_

6. 모터 켜기
   입력: CMD:MOTOR_ON_
   출력: ACK:OK_

7. 모터 끄기
   입력: CMD:MOTOR_OFF_
   출력: ACK:OK_

8. 서보 0도
   입력: CMD:SERVO,0_
   출력: ACK:OK_

9. 서보 90도
   입력: CMD:SERVO,90_
   출력: ACK:OK_

10. 서보 180도
    입력: CMD:SERVO,180_
    출력: ACK:OK_

11. 시스템 리셋
    입력: CMD:RESET_
    출력: ACK:OK_

12. 시스템 상태
    입력: REQ:STATUS_
    출력: STATUS:0,90_
```

---

## ⚙️ 설정 옵션

### 코드 상단 설정

```cpp
// 디버그 모드
#define ENABLE_DEBUG 1          // 0: 운영, 1: 개발

// 센서 모드
#define USE_REAL_SENSOR 0       // 0: 시뮬레이션, 1: 실제 센서

// 통신 속도
#define BAUD_RATE 9600
```

### 디버그 모드

**운영 모드 (ENABLE_DEBUG = 0)**
- Serial 출력 최소화
- 전력 소모 감소
- 실제 배포 시 사용

**개발 모드 (ENABLE_DEBUG = 1)**
- 상세한 디버그 메시지
- 명령 수신/처리 과정 출력
- 문제 진단 용이

---

## 🔍 문제 해결

### 문제 1: "센서 초기화 실패"

```
원인: TCS34725 센서 연결 안됨

해결:
1. USE_REAL_SENSOR = 0 (시뮬레이션 모드)
2. 센서 배선 확인 (SCL/SDA)
3. 센서 전원 확인 (3.3V 또는 5V)
```

### 문제 2: 블루투스 연결 안됨

```
원인: HC-05 모듈 문제

해결:
1. HC-05 LED 깜빡임 확인
2. 페어링: 1234 또는 0000
3. RX/TX 크로스 연결 확인
4. 전원 5V 확인
```

### 문제 3: LED가 안 켜짐

```
원인: 공통 애노드/캐소드 차이

해결:
1. 현재 코드: 공통 캐소드 기준
2. 공통 애노드 사용 시:
   analogWrite(LED_R_PIN, 255 - r);
```

### 문제 4: 서보가 떨림

```
원인: 전원 부족

해결:
1. 외부 5V 전원 사용
2. GND 공통 연결
3. 커패시터 추가 (100uF)
```

---

## 📊 에러 코드

| 코드 | 의미 | 원인 | 해결 |
|------|------|------|------|
| **100** | 알 수 없는 명령 | 명령 형식 오류 | 프로토콜 확인 |
| **101** | 알 수 없는 요청 | REQ: 타입 오류 | 요청 타입 확인 |
| **102** | 알 수 없는 제어 명령 | CMD: 명령 오류 | 제어 명령 확인 |
| **103** | LED 명령 형식 오류 | 쉼표 개수 오류 | LED,R,G,B 형식 |
| **104** | 서보 명령 형식 오류 | 각도 누락 | SERVO,각도 형식 |
| **200** | 센서 읽기 실패 | 센서 연결 안됨 | 센서 확인 |
| **201** | 액추에이터 제어 실패 | 하드웨어 문제 | 배선 확인 |

---

## 🎯 성능 최적화

### 전력 소모 감소

```cpp
1. 디버그 모드 끄기
   #define ENABLE_DEBUG 0

2. Serial 출력 최소화
   운영 모드에서는 Serial.print() 생략

3. delay 최소화
   필요한 부분에만 사용
```

### 응답 속도 향상

```cpp
1. 버퍼 크기 최적화
   String 대신 char 배열 사용 가능

2. 센서 읽기 주기 조정
   필요할 때만 읽기

3. Baud rate 증가 (선택)
   9600 → 38400 또는 115200
```

---

## 🔗 관련 문서

### 프로토콜 가이드
- **[09_앱인벤터_아두이노_센서통신_프로토콜.md](../../../docs/09_앱인벤터_아두이노_센서통신_프로토콜.md)**

### 앱인벤터 구현
- 앱인벤터 블록 코드
- UI 레이아웃
- 데이터 파싱 로직

### 블루투스 기초
- **[02_블루투스_프로토콜.md](../../../docs/02_블루투스_프로토콜.md)**

---

## 📝 라이센스

MIT License

---

## 🤝 기여

이슈 및 개선 제안 환영!

---

**작성일:** 2026-01-31  
**버전:** 1.0  
**프로젝트:** Smart Factory Arms Project
