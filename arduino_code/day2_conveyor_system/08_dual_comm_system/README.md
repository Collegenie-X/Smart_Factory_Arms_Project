# 08. Serial + Bluetooth 제어 시스템

## 개요
Serial 통신과 Bluetooth 통신을 동시에 지원하는 스마트 팩토리 컨베이어 시스템입니다.
디버깅을 위해 두 통신 방식 중 하나만 연결해도 동작하며, 메모리 최적화를 통해 안정적인 동작을 보장합니다.

## 주요 기능

### 1. 이중 통신 지원
- **Serial 통신**: USB 케이블을 통한 직접 제어
- **Bluetooth 통신**: 무선 제어 (TX=2, RX=3)
- 둘 중 하나만 연결해도 동작 가능
- 메모리 최적화로 안정적인 동시 통신

### 2. 명령어

#### `start_`
- 자동화 시작
- 컨베이어 벨트 가동
- 제품 감지 및 분류 시작

#### `stop_`
- 자동화 중지
- 컨베이어 벨트 정지
- LED 끄기
- 제품 처리 중에도 즉시 반응 (50ms 이내)

#### `init_`
- 카운터 초기화
- 빨간색, 초록색, 파란색 카운터를 0으로 설정
- 전체 제품 카운터도 0으로 초기화
- **자동으로 시스템 중지** (안전한 초기화를 위해)
- 초기화 후 `start_` 명령으로 다시 시작 가능

#### `count_` ⭐ 신규
- **실시간 카운터 조회**
- 실행/정지 상태 관계없이 현재 카운터 값 확인
- 시스템 동작을 방해하지 않는 비간섭 조회
- 출력 형식:
  - Serial: `R:5 G:3 B:2 [RUN]` 또는 `R:5 G:3 B:2 [STOP]`
  - Bluetooth: `5,3,2` (쉼표로 구분된 숫자)

### 3. 색상별 카운터
제품 색상별로 개수를 카운트하고 전송합니다:
- **빨간색 제품**: `red1_`, `red2_`, `red3_`, ...
- **초록색 제품**: `green1_`, `green2_`, `green3_`, ...
- **파란색 제품**: `blue1_`, `blue2_`, `blue3_`, ...

### 4. 실시간 모니터링
모든 상태 정보가 Serial과 Bluetooth로 동시에 전송됩니다:
- 제품 감지 알림
- 색상 분석 결과 (Raw 값, RGB 값)
- 판별된 색상
- 카운터 정보

### 5. 메모리 최적화
- **F() 매크로 사용**: 문자열을 Flash 메모리에 저장하여 RAM 절약
- **String 객체 제거**: 메모리 파편화 방지
- **tone() 함수 제거**: SoftwareSerial과의 충돌 방지
- **LED로 알림**: 부저 대신 RGB LED로 시각적 알림

## 하드웨어 연결

### 핀 맵
```
DC 모터:
- DIR: 13번 핀
- SPEED (PWM): 11번 핀

서보 모터: 9번 핀
RGB LED: 5번 핀
적외선 센서: A0번 핀
부저: 4번 핀 (현재 미사용)

Bluetooth:
- TX: 2번 핀 (Arduino → Bluetooth)
- RX: 3번 핀 (Bluetooth → Arduino)
```

### Bluetooth 모듈 (HC-05/HC-06)
```
VCC → 5V
GND → GND
TXD → 3번 핀 (Arduino RX)
RXD → 2번 핀 (Arduino TX)
```

⚠️ **주의**: Bluetooth 모듈의 TXD는 Arduino의 RX(3번)에, RXD는 Arduino의 TX(2번)에 연결합니다.

## 사용 방법

### 1. Serial Monitor 사용
1. Arduino IDE에서 Serial Monitor 열기 (Ctrl+Shift+M)
2. 보레이트: 9600
3. 명령어 입력:
   ```
   start_    // 시작
   stop_     // 중지
   init_     // 초기화
   count_    // 카운터 조회
   ```

### 2. Bluetooth 사용
1. Bluetooth 페어링 (비밀번호: 보통 1234 또는 0000)
2. Bluetooth 터미널 앱 사용 (예: Serial Bluetooth Terminal)
3. 명령어 입력:
   ```
   start_
   stop_
   init_
   count_
   ```

### 3. 카운터 조회 활용
```
시나리오 1: 실행 중 확인
  start_              → 자동화 시작
  (제품 처리 중...)
  count_              → R:5 G:3 B:2 [RUN]
  (계속 동작...)

시나리오 2: 정지 상태 확인
  stop_               → 자동화 중지
  count_              → R:5 G:3 B:2 [STOP]
  init_               → 카운터 초기화
  count_              → R:0 G:0 B:0 [STOP]
```

### 4. 디버깅 모드
- Serial만 연결: USB 케이블만 연결하고 테스트
- Bluetooth만 연결: 무선으로만 테스트
- 둘 다 연결: 동시에 모니터링 가능

## 동작 흐름

```
1. 시스템 초기화
   ↓
2. LED 깜빡임 (초기화 완료 표시)
   ↓
3. 명령 대기 (Serial || Bluetooth)
   ↓
4. start_ 수신
   ↓
5. 컨베이어 가동
   ↓
6. 제품 감지 (IR 센서)
   ↓
7. 색상 분석 (Color 센서)
   ↓
8. 색상 판별 (빨강/초록/파랑)
   ↓
9. 서보 모터로 분류
   ↓
10. RGB LED로 색상 표시
    ↓
11. 카운터 증가 및 전송
    ↓
12. 다음 제품 대기
    ↓
    (stop_ 수신 시 → 3번으로)
    (count_ 수신 시 → 카운터 출력 후 계속)
```

## 출력 예시

### 시작 시
```
========================================
  Serial + Bluetooth 제어 시스템
========================================
초기화 완료

명령어:
  start_ : 자동화 시작
  stop_  : 자동화 중지
  init_  : 카운터 초기화
  count_ : 카운터 조회
========================================
명령 대기중...

[READY]
```

### 명령 수신
```
[count]
R:0 G:0 B:0 [STOP]

[start]
========================================
  자동화 시작
========================================
컨베이어 가동 시작
```

### 제품 처리
```
========================================
제품 #1 감지됨!
========================================
--- 색상 분석 결과 ---
Raw -> R: 330, G: 121, B: 116
RGB -> R: 15, G: 5, B: 5
판별 색상: 빨간색
---------------------
제품 처리 완료
```

### 카운터 조회
```
[count]
R:5 G:3 B:2 [RUN]

Bluetooth 수신: 5,3,2
```

### 카운터 초기화
```
[init]
[알림] 자동화 모드를 먼저 중지합니다.
========================================
  카운터 초기화
========================================
빨간색: 0
초록색: 0
파란색: 0
전체 제품: 0
========================================
명령 대기중...
```

## 기술적 특징

### 1. 메모리 최적화
```cpp
// Flash 메모리 사용 (RAM 절약)
Serial.println(F("메시지"));

// String 객체 제거 (메모리 파편화 방지)
Serial.print("R:");
Serial.print(redCount);
```

### 2. 타이머 충돌 방지
- `tone()` 함수 제거: Timer2 사용으로 SoftwareSerial과 충돌
- LED로 시각적 피드백 제공

### 3. 비간섭 카운터 조회
```cpp
// count_ 명령은 약 40ms만 소요
// 자동화 동작을 방해하지 않음
if (strcmp(cmd, "count") == 0) {
  Serial.print(F("R:"));
  Serial.print(redCount);
  // ...
}
```

### 4. 버퍼 관리
```cpp
// 통신 안정성을 위한 버퍼 클리어
void clearSerialBuffer() { ... }
void clearBluetoothBuffer() { ... }
```

## 주의사항

1. **`_` 문자 필수**: 모든 명령어는 `_`로 끝나야 합니다
2. **Bluetooth 핀 번호**: TX=2번, RX=3번 핀 사용 (SoftwareSerial)
3. **동시 명령**: Serial과 Bluetooth에서 동시에 명령을 보내도 안전하게 처리됩니다
4. **실시간 중지**: 제품 처리 중에도 `stop_` 명령이 50ms 이내에 반응합니다
5. **init 명령**: `init_` 실행 시 자동으로 시스템이 중지되므로, 재시작하려면 `start_`를 다시 입력하세요
6. **count 명령**: 실행/정지 상태 관계없이 언제든지 사용 가능하며, 시스템 동작을 방해하지 않습니다

## 트러블슈팅

### Bluetooth 연결 안됨
- Bluetooth 모듈 전원 확인 (VCC → 5V, GND → GND)
- 페어링 상태 확인 (LED 깜빡임 패턴)
- 보레이트 9600 확인
- **핀 연결 재확인**: TX=2번, RX=3번

### 명령 인식 안됨
- `_` 문자 포함 확인 (예: `start_`, `count_`)
- Serial/Bluetooth 보레이트 9600 확인
- 개행 문자 설정 무관 (자동 필터링)

### 시스템이 멈추거나 재시작됨
- ✅ **해결됨**: 메모리 최적화 및 tone() 제거로 안정성 확보
- Flash 메모리(F() 매크로) 사용으로 RAM 부족 문제 해결
- SoftwareSerial 충돌 방지

### 카운터 정보 수신 안됨
- `count_` 명령으로 수동 조회 가능
- Serial Monitor와 Bluetooth 터미널 모두 확인
- 제품이 정상적으로 분류되는지 확인

### count_ 명령이 응답 없음
- 정지 상태에서 테스트: `stop_` → `count_`
- 실행 중에도 사용 가능: 약 40ms 소요
- 시리얼 모니터에서 `R:x G:x B:x [RUN/STOP]` 형식으로 출력 확인

## 앱 인벤터 연동 예시

### Bluetooth 데이터 수신
```
count_ 전송 → "5,3,2" 수신
↓
split 블록으로 분리
↓
빨간색: 5개
초록색: 3개
파란색: 2개
```

### 실시간 모니터링 앱 구현
1. 타이머 블록으로 1초마다 `count_` 전송
2. 수신된 데이터를 파싱하여 라벨에 표시
3. `start_`, `stop_`, `init_` 버튼 추가

## 버전 정보

- **v2.0**: count_ 명령 추가, 메모리 최적화, tone() 제거
- **v1.0**: Serial + Bluetooth 이중 통신 지원

## 참고 자료

- [SoftwareSerial 라이브러리](https://www.arduino.cc/en/Reference/SoftwareSerial)
- [F() 매크로 사용법](https://www.arduino.cc/reference/en/language/variables/utilities/progmem/)
- [아두이노 메모리 최적화](https://www.arduino.cc/en/Tutorial/Foundations/Memory)
