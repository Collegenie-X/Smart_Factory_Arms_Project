# 09단계: 다중 색상 분류 시스템 (5색→3공간)

## 📋 개요

08단계 시스템을 확장하여 **5가지 색상**(빨강, 초록, 파랑, 노랑, 흰색)을 인식하고 **3개 공간**에 분류하는 고급 시스템입니다.

### 주요 특징

- ✅ 5가지 색상 인식 (빨강, 초록, 파랑, 노랑, 흰색)
- ✅ 3개 분류 공간 활용 (공간별 2가지 색상 분류)
- ✅ 향상된 색상 판별 알고리즘
- ✅ Serial + Bluetooth 동시 제어
- ✅ 실시간 카운터 전송

---

## 🎨 색상 인식 시스템

### 인식 가능한 색상 (5가지)

| 색상 | RGB 특징 | 판별 조건 |
|------|----------|-----------|
| **빨간색** | R > G, R > B | 빨강 값이 가장 높음 |
| **초록색** | G > R, G > B | 초록 값이 가장 높음 |
| **파란색** | B > R, B > G | 파랑 값이 가장 높음 |
| **노란색** | R+G 높음, B 낮음 | R>400, G>400, B<200 |
| **흰색** | 전체 밝기 높음 | Sum>700, R>200, G>200, B>200 |

### 색상 판별 우선순위

```
1순위: 흰색 (전체 밝기 체크)
2순위: 노란색 (빨강+초록 조합)
3순위: 빨강/초록/파랑 (최대값 비교)
```

---

## 📦 분류 공간 구성 (3개)

### 공간별 색상 할당

```
┌─────────────────────────────────────┐
│  공간 A (30°)                       │
│  - 빨간색 제품                      │
│  - 노란색 제품                      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  공간 B (57°)                       │
│  - 초록색 제품                      │
│  - 흰색 제품                        │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│  공간 C (2°)                        │
│  - 파란색 제품                      │
└─────────────────────────────────────┘
```

### 서보 각도 설정

```cpp
#define ANGLE_SPACE_A       30    // 공간 A: 빨간색, 노란색
#define ANGLE_SPACE_B       57    // 공간 B: 초록색, 흰색
#define ANGLE_SPACE_C       2     // 공간 C: 파란색
```

---

## 🔧 하드웨어 구성

### 필수 부품

| 부품 | 개수 | 용도 |
|------|------|------|
| Arduino Uno | 1 | 메인 컨트롤러 |
| TCS34725 색상 센서 | 1 | 5가지 색상 인식 |
| 서보 모터 | 1 | 3방향 분류 |
| DC 모터 | 1 | 컨베이어 구동 |
| 적외선 센서 | 1 | 제품 감지 |
| NeoPixel LED (3개) | 1 | 색상 표시 |
| HC-06 블루투스 | 1 | 무선 제어 |

### 핀 연결

```
DC 모터:
- 방향: 13번 핀
- 속도: 11번 핀 (PWM)

서보 모터: 9번 핀

RGB LED: 5번 핀

적외선 센서: A0번 핀

블루투스 (HC-06):
- TX: 2번 핀
- RX: 3번 핀

색상 센서 (TCS34725):
- SDA: A4
- SCL: A5
```

---

## 💻 소프트웨어 구조

### 주요 함수

#### 1. 색상 판별 함수

```cpp
ColorType detectColor(int r, int g, int b)
```

**기능**: RGB 값을 분석하여 5가지 색상 중 하나를 판별

**알고리즘**:
1. 흰색 체크 (전체 밝기 > 700)
2. 노란색 체크 (R>400, G>400, B<200)
3. RGB 최대값 비교 (빨강/초록/파랑)

#### 2. 색상 정보 반환 함수

```cpp
void getColorInfo(ColorType color, const char** name, 
                  int* angle, int* ledR, int* ledG, int* ledB)
```

**기능**: 색상 타입에 따른 이름, 서보 각도, LED 색상 반환

#### 3. 명령 처리 함수

```cpp
void processCommand(char* cmd, const char* source)
```

**지원 명령**:
- `start_`: 자동화 시작
- `stop_`: 자동화 중지
- `init_`: 카운터 초기화 (5가지 색상)
- `count_`: 카운터 조회 (5가지 색상)

---

## 📊 동작 순서

### 전체 프로세스

```
1. 명령 대기 (Serial/Bluetooth)
   ↓
2. start_ 명령 수신
   ↓
3. 컨베이어 가동
   ↓
4. 적외선 센서로 제품 감지
   ↓
5. 컨베이어 일시 정지
   ↓
6. 색상 센서로 RGB 값 측정
   ↓
7. 5가지 색상 판별
   ↓
8. 해당 색상 카운터 증가
   ↓
9. 서보 모터로 분류 (3개 공간)
   ↓
10. LED로 색상 표시
   ↓
11. 컨베이어 재가동
   ↓
12. 다음 제품 대기
```

### 색상 판별 상세 로직

```cpp
// 1. 흰색 판별
if (sum > 700 && r > 200 && g > 200 && b > 200) {
    return COLOR_WHITE;
}

// 2. 노란색 판별
if (r > 400 && g > 400 && b < 200) {
    return COLOR_YELLOW;
}

// 3. 빨간색 판별
if (r > g && r > b) {
    return COLOR_RED;
}

// 4. 초록색 판별
if (g > r && g > b) {
    return COLOR_GREEN;
}

// 5. 파란색 판별
if (b > r && b > g) {
    return COLOR_BLUE;
}
```

---

## 📡 통신 프로토콜

### 명령 형식

모든 명령은 `_`로 종료됩니다.

```
start_    → 자동화 시작
stop_     → 자동화 중지
init_     → 카운터 초기화
count_    → 카운터 조회
```

### 블루투스 전송 데이터

#### 색상 감지 시

```
red3_       → 빨간색 3개 감지
green5_     → 초록색 5개 감지
blue2_      → 파란색 2개 감지
yellow4_    → 노란색 4개 감지
white1_     → 흰색 1개 감지
```

#### count_ 명령 응답

```
3,5,2,4,1
(빨강,초록,파랑,노랑,흰색)
```

---

## 🎯 사용 방법

### 1. 초기 설정

```cpp
void setup() {
  // 1. Serial 통신 시작
  Serial.begin(9600);
  bluetooth.begin(9600);
  
  // 2. 핀 모드 설정
  pinMode(PIN_MOTOR_DIR, OUTPUT);
  pinMode(PIN_MOTOR_SPEED, OUTPUT);
  pinMode(PIN_IR_SENSOR, INPUT);
  
  // 3. 서보 초기화 (3개 공간 확인)
  servo.attach(PIN_SERVO);
  servo.write(ANGLE_SPACE_A);  // 30°
  delay(500);
  servo.write(ANGLE_SPACE_B);  // 57°
  delay(500);
  servo.write(ANGLE_SPACE_C);  // 2°
  servo.detach();
  
  // 4. 색상 센서 초기화
  colorSensor.begin();
  
  // 5. LED 초기화
  led.begin();
  led.setBrightness(255);
}
```

### 2. Serial 모니터 사용

```
1. Arduino IDE 실행
2. 시리얼 모니터 열기 (Ctrl+Shift+M)
3. 보드레이트: 9600
4. 명령 입력:
   - start_  (엔터)
   - count_  (엔터)
   - stop_   (엔터)
   - init_   (엔터)
```

### 3. 블루투스 앱 사용

```
1. 앱인벤터 앱 실행
2. HC-06 연결
3. 버튼으로 명령 전송:
   - [시작] → start_
   - [중지] → stop_
   - [초기화] → init_
   - [조회] → count_
```

---

## 🔍 색상 인식 튜닝

### 임계값 조정

색상 인식이 정확하지 않을 경우 아래 값을 조정하세요:

```cpp
// 흰색 판별 기준
#define THRESHOLD_WHITE     700   // 전체 밝기 (기본: 700)

// 노란색 판별 기준
#define THRESHOLD_YELLOW_R  400   // 빨강 최소값 (기본: 400)
#define THRESHOLD_YELLOW_G  400   // 초록 최소값 (기본: 400)
#define THRESHOLD_YELLOW_B  200   // 파랑 최대값 (기본: 200)
```

### 조정 방법

1. **흰색이 다른 색으로 인식될 때**
   - `THRESHOLD_WHITE` 값을 낮춤 (예: 600)

2. **노란색이 빨간색으로 인식될 때**
   - `THRESHOLD_YELLOW_B` 값을 높임 (예: 250)

3. **노란색이 초록색으로 인식될 때**
   - `THRESHOLD_YELLOW_R` 값을 낮춤 (예: 350)

### 디버깅 출력

Serial 모니터에서 RGB 값을 확인하세요:

```
Raw -> R: 5432, G: 6789, B: 1234
RGB -> R: 252, G: 315, B: 57
판별 색상: 노란색
```

---

## 📈 성능 최적화

### 1. 색상 감지 속도

```cpp
// 센서 통합 시간 조정
Adafruit_TCS34725 colorSensor = Adafruit_TCS34725(
  TCS34725_INTEGRATIONTIME_50MS,  // 50ms (기본)
  TCS34725_GAIN_4X                // 게인 4배
);
```

**옵션**:
- `TCS34725_INTEGRATIONTIME_24MS`: 더 빠름, 정확도 낮음
- `TCS34725_INTEGRATIONTIME_101MS`: 더 느림, 정확도 높음

### 2. 컨베이어 속도

```cpp
#define MOTOR_SPEED         120   // 0~255
```

**권장값**:
- 빠른 처리: 150~200
- 정확한 인식: 80~120

### 3. 타이밍 조정

```cpp
#define DELAY_IR_DETECT     2000  // 적외선 감지 후 대기
#define DELAY_COLOR_DETECT  1500  // 색상 분석 후 대기
#define DELAY_NEXT_PRODUCT  1000  // 다음 제품 대기
```

---

## 🐛 문제 해결

### 문제 1: 노란색이 빨간색으로 인식됨

**원인**: 파란색 임계값이 너무 낮음

**해결**:
```cpp
#define THRESHOLD_YELLOW_B  250   // 200 → 250으로 증가
```

### 문제 2: 흰색이 노란색으로 인식됨

**원인**: 흰색 임계값이 너무 높음

**해결**:
```cpp
#define THRESHOLD_WHITE     600   // 700 → 600으로 감소
```

### 문제 3: 색상 인식이 불안정함

**원인**: 조명 환경 변화

**해결**:
1. 센서 주변에 차광막 설치
2. 일정한 조명 사용
3. 센서 게인 조정:
```cpp
TCS34725_GAIN_16X  // 어두운 환경
TCS34725_GAIN_4X   // 일반 환경 (기본)
TCS34725_GAIN_1X   // 밝은 환경
```

### 문제 4: 제품이 잘못된 공간으로 분류됨

**원인**: 서보 각도 오차

**해결**:
```cpp
// 각도 미세 조정
#define ANGLE_SPACE_A       32    // 30 → 32
#define ANGLE_SPACE_B       55    // 57 → 55
#define ANGLE_SPACE_C       0     // 2 → 0
```

---

## 📊 카운터 시스템

### 카운터 변수 (5개)

```cpp
int redCount = 0;      // 빨간색 제품 수
int greenCount = 0;    // 초록색 제품 수
int blueCount = 0;     // 파란색 제품 수
int yellowCount = 0;   // 노란색 제품 수
int whiteCount = 0;    // 흰색 제품 수
```

### 카운터 조회

**Serial 출력**:
```
R:3 G:5 B:2 Y:4 W:1 [RUN]
```

**Bluetooth 출력**:
```
3,5,2,4,1
```

### 카운터 초기화

```
init_ 명령 실행 시:
- 모든 카운터 → 0
- 자동화 모드 → 중지
- LED → 꺼짐
```

---

## 🎨 LED 색상 표시

### 색상별 LED 출력

| 색상 | R | G | B |
|------|---|---|---|
| 빨간색 | 255 | 0 | 0 |
| 초록색 | 0 | 255 | 0 |
| 파란색 | 0 | 0 | 255 |
| 노란색 | 255 | 255 | 0 |
| 흰색 | 255 | 255 | 255 |

### LED 제어 코드

```cpp
// 모든 LED에 같은 색상 표시
for (int i = 0; i < NUM_PIXELS; i++) {
  led.setPixelColor(i, led.Color(ledR, ledG, ledB));
}
led.show();
```

---

## 🔄 08단계와의 차이점

### 08단계 (3색상 → 3공간)

```
빨간색 → 공간 A (30°)
초록색 → 공간 B (57°)
파란색 → 공간 C (2°)
```

### 09단계 (5색상 → 3공간)

```
빨간색 → 공간 A (30°)
노란색 → 공간 A (30°)
초록색 → 공간 B (57°)
흰색   → 공간 B (57°)
파란색 → 공간 C (2°)
```

### 주요 개선 사항

1. **색상 인식 확장**: 3가지 → 5가지
2. **판별 알고리즘 개선**: 흰색/노란색 추가
3. **공간 활용 최적화**: 1공간당 2가지 색상
4. **카운터 시스템 확장**: 5개 독립 카운터

---

## 📚 참고 자료

### 색상 센서 (TCS34725)

- 데이터시트: [Adafruit TCS34725](https://www.adafruit.com/product/1334)
- RGB 값 범위: 0 ~ 65535 (16비트)
- 매핑 범위: 0 ~ 1000 (계산 편의)

### RGB 색상 모델

```
빨간색: (255, 0, 0)
초록색: (0, 255, 0)
파란색: (0, 0, 255)
노란색: (255, 255, 0) = 빨강 + 초록
흰색: (255, 255, 255) = 빨강 + 초록 + 파랑
```

---

## 🎯 실습 과제

### 과제 1: 색상 추가

**목표**: 주황색(Orange) 인식 추가

**힌트**:
```cpp
// 주황색: R > 500, G > 200, G < 400, B < 150
if (r > 500 && g > 200 && g < 400 && b < 150) {
    return COLOR_ORANGE;
}
```

### 과제 2: 분류 공간 변경

**목표**: 4개 공간으로 확장

**힌트**:
```cpp
#define ANGLE_SPACE_D       90    // 새로운 공간 추가
```

### 과제 3: 통계 기능

**목표**: 전체 제품 수 대비 색상별 비율 계산

**힌트**:
```cpp
float redRatio = (float)redCount / productCount * 100;
Serial.print("빨간색 비율: ");
Serial.print(redRatio);
Serial.println("%");
```

---

## ✅ 체크리스트

### 하드웨어 점검

- [ ] 모든 센서 연결 확인
- [ ] 서보 모터 3개 각도 테스트
- [ ] LED 색상 표시 확인
- [ ] 블루투스 통신 테스트

### 소프트웨어 점검

- [ ] 5가지 색상 인식 테스트
- [ ] 3개 공간 분류 확인
- [ ] 카운터 증가 확인
- [ ] 명령 처리 테스트 (start, stop, init, count)

### 성능 점검

- [ ] 색상 인식 정확도 > 90%
- [ ] 분류 속도 < 5초/제품
- [ ] 카운터 오차 = 0

---

## 📞 문의

문제가 발생하면 아래 정보를 확인하세요:

1. **Serial 모니터 출력**: RGB 값 확인
2. **LED 색상**: 판별 결과 확인
3. **서보 각도**: 분류 방향 확인
4. **카운터 값**: 누적 개수 확인

---

**작성일**: 2026-01-28  
**버전**: 1.0  
**작성자**: Smart Factory Team

