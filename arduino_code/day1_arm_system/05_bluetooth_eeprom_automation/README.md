# 로봇 팔 - 5단계: Bluetooth EEPROM 자동화 시스템

## 개요

Bluetooth로 무선 제어하는 로봇 팔 자동화 시스템입니다. 조이스틱으로 위치를 설정하고 저장한 후, Bluetooth나 Serial 명령으로 자동 재생할 수 있습니다.

## 주요 기능

- ✅ Bluetooth 무선 제어
- ✅ EEPROM에 최대 12단계 저장
- ✅ 저장된 동작 1회 재생
- ✅ 저장된 동작 무한 반복
- ✅ Serial과 Bluetooth 동시 지원 (디버깅)
- ✅ auto 실행 중 stop 명령으로 즉시 중지
- ✅ 전원이 꺼져도 저장 유지

## 하드웨어 연결

### ⚠️ 중요: 전원 공급
```
USB 전원(500mA)으로는 서보 4개를 안정적으로 구동하기 어렵습니다!

권장 사항:
1. 외부 5V 전원 어댑터 사용 (2A 이상)
2. 서보 모터 전원은 외부 전원에서 공급
3. 아두이노와 서보 모터의 GND 공통 연결
4. 전원 부족 시 아두이노 리셋, 오작동 발생 가능
```

### Bluetooth 모듈 (HC-05/HC-06)
```
VCC → 5V
GND → GND
TX  → Arduino 2번 핀
RX  → Arduino 3번 핀
```

### 서보 모터
```
서보 1 (베이스)  → 4번 핀
서보 2 (팔꿈치) → 5번 핀
서보 3 (손목)   → 6번 핀
서보 4 (그립)   → 7번 핀

⚠️ 서보 전원은 외부 5V 전원 권장!
```

### 조이스틱
```
조이스틱 1 X축 → A0 (베이스)
조이스틱 1 Y축 → A1 (팔꿈치)
조이스틱 2 X축 → A2 (손목)
조이스틱 2 Y축 → A3 (그립)
```

## 명령어

| 명령어 | 설명 |
|--------|------|
| `save` | 현재 위치 저장 (최대 12개) |
| `play` | 저장된 동작 1회 재생 |
| `auto` | 저장된 동작 계속 반복 |
| `stop` | 자동 반복 즉시 중지 |
| `clear` | 모든 위치 삭제 |
| `list` | 저장된 위치 목록 |

## 사용 방법

### 1. Bluetooth 연결

1. 스마트폰에 Bluetooth 터미널 앱 설치 (예: Serial Bluetooth Terminal)
2. HC-05/HC-06 모듈과 페어링 (기본 PIN: 1234 또는 0000)
3. 앱에서 HC-05/HC-06 연결

### 2. 위치 저장

1. 조이스틱으로 원하는 위치로 이동
2. Bluetooth 터미널에서 `save` 입력
3. 다음 위치로 이동 후 다시 `save`
4. 최대 12개까지 저장 가능

### 3. 자동 재생

**1회 재생:**
```
play
```

**계속 반복:**
```
auto
```

**중지:**
```
stop
```

### 4. 관리

**저장된 위치 확인:**
```
list
```

**모든 위치 삭제:**
```
clear
```

## 출력 예시

### Bluetooth에서 save 명령
```
[명령 from Bluetooth] save
[저장 완료] 위치 #1 - 베이스:90 팔꿈치:90 손목:90 그립:5
저장된 위치: 1 / 12
```

### 자동 반복 실행
```
[명령 from Bluetooth] auto
========================================
  자동 반복 모드 시작
========================================
저장된 위치 수: 3
'stop' 명령으로 중지
========================================

========================================
  반복 #1 실행 중...
========================================
→ 위치 #1 이동
  베이스:90 팔꿈치:90 손목:90 그립:5
→ 위치 #2 이동
  베이스:45 팔꿈치:100 손목:80 그립:30
→ 위치 #3 이동
  베이스:120 팔꿈치:85 손목:95 그립:15

========================================
  반복 #2 실행 중...
========================================
...
```

### Serial에서 중지
```
[명령 from Serial] stop
========================================
  자동 반복 모드 중지
========================================
총 반복 횟수: 5
========================================

조이스틱으로 제어하세요
```

## 특징

### 1. 이중 통신 지원
- **Bluetooth:** 무선으로 명령 전송 (주 사용)
- **Serial:** PC USB 연결로 디버깅

둘 중 하나 또는 둘 다 사용 가능합니다.

### 2. 명령 출처 표시
```
[명령 from Bluetooth] save  // Bluetooth로 받은 명령
[명령 from Serial] stop      // Serial로 받은 명령
```

### 3. 즉시 중지 기능
- `auto` 실행 중 언제든지 `stop` 입력하면 즉시 중지
- 이동 중에도 명령 체크하여 빠른 응답

### 4. EEPROM 영구 저장
- 전원이 꺼져도 저장된 위치 유지
- 아두이노를 다시 켜면 이전 저장 위치 그대로 사용 가능

## 테스트 방법

1. **업로드**
   - Arduino IDE에서 업로드

2. **Bluetooth 연결**
   - 스마트폰 또는 PC로 HC-05/HC-06 연결

3. **Serial Monitor 열기** (선택사항)
   - 디버깅용으로 Serial Monitor 열어두기
   - 보드레이트: 9600

4. **기본 동작 테스트**
   - 조이스틱으로 움직이는지 확인
   - Serial/Bluetooth 출력 확인

5. **저장 테스트**
   - 여러 위치를 `save`로 저장
   - `list`로 확인

6. **재생 테스트**
   - `play`로 1회 재생
   - `auto`로 반복 재생
   - `stop`으로 중지

7. **전원 OFF/ON 테스트**
   - 전원을 껐다 켜도 `list`로 확인 시 저장 유지

## 문제 해결

### ⚠️ 전원이 꺼지거나 아두이노가 리셋됨
**원인:** 서보 모터 과전류로 인한 브라운아웃

**해결 방법:**
1. **외부 전원 사용 (가장 확실한 방법)**
   ```
   - 5V 2A 이상 전원 어댑터 사용
   - 서보 모터만 외부 전원에 연결
   - 아두이노와 외부 전원의 GND 연결
   - 아두이노는 USB 또는 외부 전원 선택
   ```

2. **USB 전원만 사용 시**
   ```
   - 고성능 USB 포트 사용 (USB 3.0)
   - USB 허브 사용 금지
   - 서보를 하나씩만 움직이기
   - 서보 부하 최소화 (무게 제거)
   ```

3. **초기화 시 리셋되는 경우**
   ```
   - 코드가 이미 천천히 초기화하도록 수정됨
   - 그래도 문제 시 외부 전원 필수
   ```

### Bluetooth 연결 안됨
- HC-05/HC-06 모듈 전원 확인
- 페어링 PIN 확인 (1234 또는 0000)
- TX/RX 핀 연결 확인 (교차 연결 필요 없음)

### 명령 인식 안됨
- 명령어 정확히 입력 (소문자)
- 앱에서 Enter 또는 줄바꿈 전송 확인

### 조이스틱 사용 시 시스템 느려지거나 멈춤
**원인:** SoftwareSerial(Bluetooth)과 Servo 라이브러리의 타이머 충돌

**해결됨:**
- 조이스틱 제어 중에는 Serial만 출력 (Bluetooth 출력 안 함)
- 명령어 입력/출력만 Bluetooth 사용
- 이미 코드에 적용되어 있음

### 서보 모터 움직임 이상
- 각도 범위 확인:
  - 베이스: 0~180
  - 팔꿈치: 50~110
  - 손목: 60~120
  - 그립: 5~60
- 조이스틱 연결 확인
- **전원 부족 확인 (가장 흔한 원인)**

### stop 명령 안 먹힘
- 명령 입력 후 Enter 누르기
- Serial Monitor에서 테스트

## EEPROM 구조

```
주소 0~3   : 저장된 위치 개수 (int)
주소 4~7   : 위치 #1 (4개 서보 각도)
주소 8~11  : 위치 #2
주소 12~15 : 위치 #3
...
주소 48~51 : 위치 #12
```

## 응용 아이디어

1. **물건 운반 자동화**
   - 픽업 위치 → 운반 위치를 저장하여 반복 실행

2. **댄스 동작**
   - 12단계 동작을 저장하여 반복 재생

3. **교육용 시연**
   - 미리 저장된 동작을 보여주며 설명

4. **원격 제어 로봇**
   - Bluetooth로 멀리서 조종

## 다음 단계

6단계에서는 다음 기능이 추가됩니다:
- 피에조 부저 (알림음, 효과음)
- 8x8 LED Matrix (상태 표시, 이모티콘)
